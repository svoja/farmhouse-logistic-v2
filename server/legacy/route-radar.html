<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farmhouse Logistic ‚Äî Route Radar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <style>
    .route-tooltip { max-width: 280px; white-space: normal; }
    #map { min-height: 400px; }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <main class="flex-1 flex flex-col min-h-0">
    <div class="px-4 py-2 border-b border-slate-100 bg-slate-50/50 flex flex-wrap items-center justify-between gap-2">
      <div class="flex items-center gap-3 flex-wrap">
        <a href="/" class="text-slate-600 hover:text-sky-600 hover:bg-sky-50 p-2 rounded-lg inline-flex items-center" title="‡∏Å‡∏•‡∏±‡∏ö">
          <span class="material-symbols-outlined text-xl">arrow_back</span>
        </a>
        <h2 class="text-base font-semibold text-slate-700">Route Radar ‚Äî live tracking</h2>
      </div>
      <div class="flex items-center gap-3 flex-wrap">
        <span class="text-xs font-medium text-slate-500">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</span>
        <select id="radar-route-type-filter" class="text-sm border border-slate-200 rounded-lg px-2.5 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-sky-500/40" aria-label="Filter by route type">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="1">10 ‡∏•‡πâ‡∏≠</option>
          <option value="2">4 ‡∏•‡πâ‡∏≠</option>
        </select>
        <button type="button" id="radar-refresh-now" class="text-sm font-medium text-sky-600 hover:text-sky-700 hover:bg-sky-50 px-2 py-1 rounded flex items-center gap-1" title="Refresh now">
          <span class="material-symbols-outlined text-lg">refresh</span> Refresh now
        </button>
        <span id="radar-legend" class="text-sm text-slate-500">Branches: ‚Äî</span>
        <span id="radar-live-badge" class="text-xs font-medium text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded">Auto-refresh 1m</span>
      </div>
    </div>
    <div class="flex-1 flex min-h-0 relative">
      <div id="map" class="flex-1 min-h-[400px]"></div>
      <aside id="radar-info-panel" class="w-72 border-l border-slate-200 bg-white overflow-y-auto flex-shrink-0">
        <div class="p-3 border-b border-slate-100">
          <h3 class="text-sm font-semibold text-slate-700">Cars & orders</h3>
          <p class="text-xs text-slate-500 mt-0.5">Click a car on the map or in the list below for details</p>
        </div>
        <div id="radar-info-content" class="p-3 text-sm text-slate-600">
          <p class="text-slate-500">Loading‚Ä¶</p>
        </div>
      </aside>
      <div id="car-detail-panel" class="hidden absolute top-4 left-4 right-4 md:right-auto md:w-[22rem] z-[1000] bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden flex flex-col max-h-[calc(100%-2rem)]">
        <div class="bg-slate-700 text-white px-4 py-3 flex items-start justify-between gap-2 shrink-0">
          <div>
            <div class="font-semibold text-lg flex items-center gap-2">
              <span aria-hidden="true">üöö</span>
              <span id="car-detail-plate"></span>
            </div>
            <div class="text-slate-300 text-sm mt-0.5" id="car-detail-type"></div>
          </div>
          <button type="button" id="car-detail-close" class="p-1 rounded hover:bg-slate-600 text-slate-300 hover:text-white" aria-label="Close">
            <span class="material-symbols-outlined text-xl">close</span>
          </button>
        </div>
        <div class="p-4 overflow-y-auto flex-1 min-h-0 text-sm">
          <div class="mb-4">
            <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Route & deliveries</h4>
            <div id="car-detail-route" class="text-slate-700 space-y-1.5"></div>
          </div>
          <div class="mb-4">
            <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Route stops / ‡∏à‡∏∏‡∏î‡πÅ‡∏ß‡∏∞</h4>
            <ul id="car-detail-orders" class="space-y-2 text-slate-700"></ul>
          </div>
          <div>
            <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Status</h4>
            <p id="car-detail-status" class="text-slate-600"></p>
          </div>
          <div id="car-detail-debug" class="mt-4 pt-3 border-t border-slate-200 hidden">
            <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Debug</h4>
            <div class="flex flex-col gap-2">
              <button type="button" id="car-detail-debug-in-transit" class="text-sm font-medium text-sky-700 bg-sky-50 hover:bg-sky-100 px-3 py-2 rounded-lg">Auto ‚Üí IN_TRANSIT</button>
              <button type="button" id="car-detail-debug-complete" class="text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 px-3 py-2 rounded-lg">Complete (COMPLETED)</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="/route-radar.js"></script>
  <script>
    window.onGoogleMapsReady = function() {
      window._googleMapsReady = true;
      if (window.initRouteRadar) {
        try { window.initRouteRadar(); } catch (e) {
          var el = document.getElementById("map");
          if (el) el.innerHTML = "<div class=\"p-4 text-red-600\">Map init error: " + (e.message || e) + "</div>";
        }
      } else {
        var el = document.getElementById("map");
        if (el) el.innerHTML = "<div class=\"p-4 text-red-600\">Route Radar script did not load. Check that /route-radar.js exists and refresh.</div>";
      }
    };
    fetch("/api/config")
      .then(function(r) { return r.json(); })
      .then(function(cfg) {
        if (!cfg.googleMapsApiKey) {
          var el = document.getElementById("map");
          if (el) el.innerHTML = "<div class=\"p-4 flex items-center justify-center h-full text-red-600\">Set GOOGLE_MAPS_API_KEY in .env and enable Maps JavaScript API and Directions API in Google Cloud.</div>";
          document.getElementById("radar-info-content").innerHTML = "<p class=\"text-slate-500\">No map ‚Äî add API key.</p>";
          return;
        }
        var s = document.createElement("script");
        s.src = "https://maps.googleapis.com/maps/api/js?key=" + encodeURIComponent(cfg.googleMapsApiKey) + "&libraries=geometry&loading=async&callback=onGoogleMapsReady";
        s.onerror = function() {
          var el = document.getElementById("map");
          if (el) el.innerHTML = "<div class=\"p-4 text-red-600\">Google Maps script failed to load. Check network and API key.</div>";
        };
        document.head.appendChild(s);
      })
      .catch(function(err) {
        var el = document.getElementById("map");
        if (el) el.innerHTML = "<div class=\"p-4 text-red-600\">Failed to load config.</div>";
      });
  </script>
</body>
</html>
